<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Admin felület</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(120deg, #e0eafc 0%, #cfdef3 100%);
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 800px;
            margin: 3em auto;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 2em 3em;
        }
        h1, h2 {
            color: #2a4d69;
            margin-bottom: 0.5em;
        }
        #login {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1em;
        }
        input[type="text"], input[type="password"] {
            padding: 0.7em;
            border: 1px solid #b0c4de;
            border-radius: 8px;
            width: 220px;
            font-size: 1em;
            margin-bottom: 0.5em;
        }
        button {
            background: #2a4d69;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 0.7em 1.5em;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:disabled {
            background: #b0c4de;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background: #4b86b4;
        }
        .hidden { display: none; }
        #stats {
            display: flex;
            gap: 2em;
            margin-bottom: 2em;
        }
        .stat-card {
            background: #f6f9fb;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(42,77,105,0.07);
            padding: 1em 2em;
            text-align: center;
            min-width: 120px;
        }
        .stat-card p {
            margin: 0.5em 0 0 0;
            font-size: 1.2em;
            color: #2a4d69;
        }
        #stations {
            display: flex;
            flex-direction: column;
            gap: 1em;
        }
        .station {
            background: #f6f9fb;
            border-radius: 14px;
            box-shadow: 0 4px 16px rgba(42,77,105,0.10);
            padding: 1.5em 2em;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }
        .station:hover {
            box-shadow: 0 8px 32px rgba(42,77,105,0.18);
        }
        .station-info {
            display: flex;
            flex-direction: column;
            gap: 0.3em;
        }
        .station-title {
            font-size: 1.25em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5em;
        }
        .station-icon {
            width: 28px;
            height: 28px;
            background: #4b86b4;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 1.1em;
        }
        .station-status {
            font-size: 1em;
            font-weight: 500;
            padding: 0.2em 0.7em;
            border-radius: 6px;
            display: inline-block;
            margin-top: 0.2em;
        }
        .station-status.aktiv {
            background: #d4f7dc;
            color: #27ae60;
        }
        .station-status.inaktiv {
            background: #ffe3e3;
            color: #e74c3c;
        }
        .station-coords {
            font-size: 0.95em;
            color: #888;
            margin-top: 0.2em;
        }
        .fixed-label {
            color: #27ae60;
            font-weight: bold;
            margin-left: 1em;
            font-size: 1em;
        }
        .station-actions {
            display: flex;
            gap: 0.5em;
        }
        .station-actions button {
            padding: 0.5em 1.1em;
            border-radius: 7px;
            font-size: 1em;
            border: none;
            background: #e0eafc;
            color: #2a4d69;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            box-shadow: 0 2px 8px rgba(42,77,105,0.07);
        }
        .station-actions button:hover:not(:disabled) {
            background: #4b86b4;
            color: #fff;
        }
        .station-actions button:disabled {
            background: #b0c4de;
            color: #fff;
            cursor: not-allowed;
        }
        .station-delete {
            background: #ffe3e3;
            color: #e74c3c;
        }
        .station-delete:hover:not(:disabled) {
            background: #e74c3c;
            color: #fff;
        }
        .station-fix {
            background: #d4f7dc;
            color: #27ae60;
        }
        .station-fix:hover:not(:disabled) {
            background: #27ae60;
            color: #fff;
        }
        .station-edit {
            background: #e0eafc;
            color: #2a4d69;
        }
        .station-edit:hover:not(:disabled) {
            background: #4b86b4;
            color: #fff;
        }
        .station-anim {
            animation: stationFadeIn 0.5s;
        }
        @keyframes stationFadeIn {
            from { opacity: 0; transform: translateY(20px);}
            to { opacity: 1; transform: translateY(0);}
        }
        #map {
            width: 100%;
            height: 350px;
            margin-bottom: 2em;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(42,77,105,0.07);
        }
        @media (max-width: 600px) {
            .container { padding: 1em; }
            #stats { flex-direction: column; gap: 1em; }
            .station { flex-direction: column; align-items: flex-start; }
        }
        .station-coords-btn {
            background: none;
            border: none;
            color: #4b86b4;
            font-size: 1.1em;
            cursor: pointer;
            padding: 0;
            margin-left: 0.2em;
            vertical-align: middle;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .station-coords-btn:hover {
            opacity: 1;
        }
        .coords-popup {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            color: #2a4d69;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(42,77,105,0.15);
            padding: 1em 2em;
            z-index: 3000;
            font-size: 1em;
            min-width: 180px;
            text-align: center;
        }
        .coords-popup button {
            margin-top: 0.7em;
            background: #4b86b4;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.3em 1em;
            cursor: pointer;
            font-size: 0.95em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Admin felület</h1>
        <div id="login">
            <h2>Bejelentkezés</h2>
            <input type="text" id="username" placeholder="Felhasználónév">
            <input type="password" id="password" placeholder="Jelszó">
            <button onclick="login()">Bejelentkezés</button>
            <div id="login-error" style="color:#e74c3c;"></div>
        </div>
        <div id="admin-panel" class="hidden">
            <h2>Statisztikák</h2>
            <div id="stats"></div>
            <h2>Állomások térképen</h2>
            <div id="map"></div>
            <h2>Állomások kezelése</h2>
            <button id="add-station-btn" style="margin-bottom:1em;background:#27ae60;color:#fff;padding:0.7em 1.5em;border:none;border-radius:8px;font-size:1em;cursor:pointer;">&#43; Új állomás</button>
            <div id="stations"></div>
        </div>
    </div>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Dummy adatok, cseréld le backend API hívásokra!
        const adminUser = { username: "admin", password: "admin123" };
        let stations = [
            { id: 1, name: "Kinizsi vár", status: "aktív", lat: 47.02513, lng: 17.64998 },
            { id: 2, name: "Szent Ilona romok", status: "inaktív", lat: 47.02780, lng: 17.65420 },
            { id: 3, name: "Forrás", status: "aktív", lat: 47.03010, lng: 17.65250 }
        ];
        let stats = {
            users: 42,
            stations: stations.length,
            activeStations: stations.filter(s => s.status === "aktív").length
        };

        let map, markers = [];

        function login() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if (u === adminUser.username && p === adminUser.password) {
                // Teljesen eltávolítjuk a bejelentkezős részt
                const loginDiv = document.getElementById('login');
                if (loginDiv) loginDiv.parentNode.removeChild(loginDiv);
                document.getElementById('admin-panel').classList.remove('hidden');
                renderStats();
                renderStations();
                setTimeout(initMap, 100); // Térkép inicializálása
            } else {
                document.getElementById('login-error').innerText = "Hibás felhasználónév vagy jelszó!";
            }
        }

        function initMap() {
            if (map) { map.remove(); markers = []; }
            map = L.map('map').setView([47.026, 17.652], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(map);

            updateMapMarkers(); // <-- azonnal a színes markerekkel
        }

        function updateMapMarkers() {
            if (!map) return;
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            stations.forEach(station => {
                // Aktív: zöld marker, inaktív: piros marker
                const markerIcon = L.icon({
                    iconUrl: station.status === 'aktív'
                        ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png'
                        : 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                });
                const marker = L.marker([station.lat, station.lng], { icon: markerIcon, draggable: false })
                    .addTo(map)
                    .bindPopup(`<strong>${station.name}</strong><br>${station.status.charAt(0).toUpperCase() + station.status.slice(1)}`);
                markers.push(marker);
            });
        }

        function renderStats() {
            document.getElementById('stats').innerHTML = `
                <div class="stat-card">
                    <strong>Felhasználók száma</strong>
                    <p>${stats.users}</p>
                </div>
                <div class="stat-card">
                    <strong>Állomások száma</strong>
                    <p>${stats.stations}</p>
                </div>
                <div class="stat-card">
                    <strong>Aktív állomások</strong>
                    <p>${stats.activeStations}</p>
                </div>
            `;
        }

        function renderStations() {
            const container = document.getElementById('stations');
            container.innerHTML = '';
            stations.forEach(station => {
                container.innerHTML += `
                    <div class="station station-anim">
                        <div class="station-info">
                            <div class="station-title">
                                <span class="station-icon" title="Állomás">&#128205;</span>
                                ${station.name}
                                <button class="station-coords-btn" title="Koordináta megjelenítése" onclick="showCoords(${station.id})">&#128269;</button>
                            </div>
                            <span class="station-status ${station.status === 'aktív' ? 'aktiv' : 'inaktiv'}">
                                ${station.status.charAt(0).toUpperCase() + station.status.slice(1)}
                            </span>
                        </div>
                        <div class="station-actions">
                            <button class="station-edit" onclick="editStation(${station.id})" title="Szerkesztés">&#9998; Szerkesztés</button>
                            <button class="station-delete" onclick="deleteStation(${station.id})" title="Törlés">&#128465; Törlés</button>
                        </div>
                    </div>
                `;
            });
            updateMapMarkers();
        }

        function showCoords(id) {
            const station = stations.find(s => s.id === id);
            // Ha már van ilyen popup, előbb eltávolítjuk
            const oldPopup = document.getElementById('coords-popup');
            if (oldPopup) oldPopup.parentNode.removeChild(oldPopup);

            const popup = document.createElement('div');
            popup.className = 'coords-popup';
            popup.id = 'coords-popup';
            popup.innerHTML = `
                <strong>Koordináta</strong><br>
                ${station.lat.toFixed(5)}, ${station.lng.toFixed(5)}
                <br>
                <button onclick="closeCoordsPopup()">Bezár</button>
            `;
            document.body.appendChild(popup);
        }
        function closeCoordsPopup() {
            const popup = document.getElementById('coords-popup');
            if (popup) popup.parentNode.removeChild(popup);
        }

        function deleteStation(id) {
            if (confirm("Biztosan törölni szeretnéd az állomást?")) {
                stations = stations.filter(s => s.id !== id);
                stats.stations = stations.length;
                stats.activeStations = stations.filter(s => s.status === "aktív").length;
                renderStats();
                renderStations();
            }
        }

        function editStation(id) {
            const station = stations.find(s => s.id === id);
            // Modern, igényes szerkesztő ablak
            const modalBg = document.createElement('div');
            modalBg.style.position = 'fixed';
            modalBg.style.top = 0;
            modalBg.style.left = 0;
            modalBg.style.width = '100vw';
            modalBg.style.height = '100vh';
            modalBg.style.background = 'rgba(42,77,105,0.15)';
            modalBg.style.display = 'flex';
            modalBg.style.alignItems = 'center';
            modalBg.style.justifyContent = 'center';
            modalBg.style.zIndex = 1000;

            const modal = document.createElement('div');
            modal.style.background = '#fff';
            modal.style.borderRadius = '12px';
            modal.style.boxShadow = '0 4px 24px rgba(42,77,105,0.15)';
            modal.style.padding = '2em 2em';
            modal.style.minWidth = '320px';
            modal.innerHTML = `
                <h3>Állomás szerkesztése</h3>
                <label>
                    Név:<br>
                    <input type="text" id="modal-name" value="${station.name}" style="width:100%;padding:0.5em;margin-bottom:1em;">
                </label>
                <label>
                    Státusz:<br>
                    <select id="modal-status" style="width:100%;padding:0.5em;">
                        <option value="aktív" ${station.status === "aktív" ? "selected" : ""}>Aktív</option>
                        <option value="inaktív" ${station.status === "inaktív" ? "selected" : ""}>Inaktív</option>
                    </select>
                </label>
                <label>
                    Pozíció:<br>
                    <input type="number" id="modal-lat" value="${station.lat}" step="0.0001" style="width:48%;padding:0.5em;"> 
                    <input type="number" id="modal-lng" value="${station.lng}" step="0.0001" style="width:48%;padding:0.5em;">
                </label>
                <div style="margin-top:1.5em; text-align:right;">
                    <button id="modal-save">Mentés</button>
                    <button id="modal-cancel" style="background:#b0c4de;color:#2a4d69;">Mégsem</button>
                </div>
                <div style="margin-top:1em;">
                    <button id="pick-on-map" style="background:#4b86b4;">Kijelölés térképen</button>
                    <span id="pick-hint" style="color:#888;font-size:0.95em;"></span>
                </div>
            `;
            modalBg.appendChild(modal);
            document.body.appendChild(modalBg);

            let picking = false;
            document.getElementById('pick-on-map').onclick = function() {
                picking = true;
                document.body.removeChild(modalBg); // szerkesztő ablak eltüntetése
                let hintDiv = document.createElement('div');
                hintDiv.id = "pick-hint-map";
                hintDiv.style.position = "fixed";
                hintDiv.style.top = "20px";
                hintDiv.style.left = "50%";
                hintDiv.style.transform = "translateX(-50%)";
                hintDiv.style.background = "#4b86b4";
                hintDiv.style.color = "#fff";
                hintDiv.style.padding = "1em 2em";
                hintDiv.style.borderRadius = "8px";
                hintDiv.style.zIndex = 2000;
                hintDiv.style.boxShadow = "0 2px 8px rgba(42,77,105,0.15)";
                hintDiv.innerText = "Kattints a térképen az új pozícióhoz!";
                document.body.appendChild(hintDiv);

                map.getContainer().style.cursor = "crosshair";
                map.once('click', function(e) {
                    document.body.removeChild(hintDiv);
                    map.getContainer().style.cursor = "";
                    // újra megjelenítjük a szerkesztő ablakot, kitöltve az új koordinátákkal
                    editStationWithCoords(id, e.latlng.lat, e.latlng.lng);
                });
            };

            document.getElementById('modal-save').onclick = function() {
                const newName = document.getElementById('modal-name').value.trim();
                const newStatus = document.getElementById('modal-status').value;
                const newLat = parseFloat(document.getElementById('modal-lat').value);
                const newLng = parseFloat(document.getElementById('modal-lng').value);
                if (newName) station.name = newName;
                station.status = newStatus;
                if (!isNaN(newLat) && !isNaN(newLng)) {
                    station.lat = newLat;
                    station.lng = newLng;
                }
                stats.activeStations = stations.filter(s => s.status === "aktív").length;
                renderStats();
                renderStations();
                document.body.removeChild(modalBg);
            };
            document.getElementById('modal-cancel').onclick = function() {
                document.body.removeChild(modalBg);
                if (picking) map.getContainer().style.cursor = "";
            };
        }

        // Új segédfüggvény: szerkesztő ablak megjelenítése előre kitöltött koordinátákkal
        function editStationWithCoords(id, lat, lng) {
            const station = stations.find(s => s.id === id);
            // Modern, igényes szerkesztő ablak
            const modalBg = document.createElement('div');
            modalBg.style.position = 'fixed';
            modalBg.style.top = 0;
            modalBg.style.left = 0;
            modalBg.style.width = '100vw';
            modalBg.style.height = '100vh';
            modalBg.style.background = 'rgba(42,77,105,0.15)';
            modalBg.style.display = 'flex';
            modalBg.style.alignItems = 'center';
            modalBg.style.justifyContent = 'center';
            modalBg.style.zIndex = 1000;

            const modal = document.createElement('div');
            modal.style.background = '#fff';
            modal.style.borderRadius = '12px';
            modal.style.boxShadow = '0 4px 24px rgba(42,77,105,0.15)';
            modal.style.padding = '2em 2em';
            modal.style.minWidth = '320px';
            modal.innerHTML = `
                <h3>Állomás szerkesztése</h3>
                <label>
                    Név:<br>
                    <input type="text" id="modal-name" value="${station.name}" style="width:100%;padding:0.5em;margin-bottom:1em;">
                </label>
                <label>
                    Státusz:<br>
                    <select id="modal-status" style="width:100%;padding:0.5em;">
                        <option value="aktív" ${station.status === "aktív" ? "selected" : ""}>Aktív</option>
                        <option value="inaktív" ${station.status === "inaktív" ? "selected" : ""}>Inaktív</option>
                    </select>
                </label>
                <label>
                    Pozíció:<br>
                    <input type="number" id="modal-lat" value="${lat}" step="0.0001" style="width:48%;padding:0.5em;"> 
                    <input type="number" id="modal-lng" value="${lng}" step="0.0001" style="width:48%;padding:0.5em;">
                </label>
                <div style="margin-top:1.5em; text-align:right;">
                    <button id="modal-save">Mentés</button>
                    <button id="modal-cancel" style="background:#b0c4de;color:#2a4d69;">Mégsem</button>
                </div>
                <div style="margin-top:1em;">
                    <button id="pick-on-map" style="background:#4b86b4;">Kijelölés térképen</button>
                    <span id="pick-hint" style="color:#888;font-size:0.95em;"></span>
                </div>
            `;
            modalBg.appendChild(modal);
            document.body.appendChild(modalBg);

            let picking = false;
            document.getElementById('pick-on-map').onclick = function() {
                picking = true;
                document.body.removeChild(modalBg);
                let hintDiv = document.createElement('div');
                hintDiv.id = "pick-hint-map";
                hintDiv.style.position = "fixed";
                hintDiv.style.top = "20px";
                hintDiv.style.left = "50%";
                hintDiv.style.transform = "translateX(-50%)";
                hintDiv.style.background = "#4b86b4";
                hintDiv.style.color = "#fff";
                hintDiv.style.padding = "1em 2em";
                hintDiv.style.borderRadius = "8px";
                hintDiv.style.zIndex = 2000;
                hintDiv.style.boxShadow = "0 2px 8px rgba(42,77,105,0.15)";
                hintDiv.innerText = "Kattints a térképen az új pozícióhoz!";
                document.body.appendChild(hintDiv);

                map.getContainer().style.cursor = "crosshair";
                map.once('click', function(e) {
                    document.body.removeChild(hintDiv);
                    map.getContainer().style.cursor = "";
                    editStationWithCoords(id, e.latlng.lat, e.latlng.lng);
                });
            };

            document.getElementById('modal-save').onclick = function() {
                const newName = document.getElementById('modal-name').value.trim();
                const newStatus = document.getElementById('modal-status').value;
                const newLat = parseFloat(document.getElementById('modal-lat').value);
                const newLng = parseFloat(document.getElementById('modal-lng').value);
                if (newName) station.name = newName;
                station.status = newStatus;
                if (!isNaN(newLat) && !isNaN(newLng)) {
                    station.lat = newLat;
                    station.lng = newLng;
                }
                stats.activeStations = stations.filter(s => s.status === "aktív").length;
                renderStats();
                renderStations();
                document.body.removeChild(modalBg);
            };
            document.getElementById('modal-cancel').onclick = function() {
                document.body.removeChild(modalBg);
                if (picking) map.getContainer().style.cursor = "";
            };
        }

        document.addEventListener('DOMContentLoaded', function() {
            const panel = document.getElementById('admin-panel');
            if (panel) {
                panel.addEventListener('click', function(e) {
                    if (e.target && e.target.id === 'add-station-btn') {
                        addStationModal();
                    }
                });
            }
        });

        function addStationModal(lat = '', lng = '', name = '', status = 'aktív') {
            const modalBg = document.createElement('div');
            modalBg.style.position = 'fixed';
            modalBg.style.top = 0;
            modalBg.style.left = 0;
            modalBg.style.width = '100vw';
            modalBg.style.height = '100vh';
            modalBg.style.background = 'rgba(42,77,105,0.15)';
            modalBg.style.display = 'flex';
            modalBg.style.alignItems = 'center';
            modalBg.style.justifyContent = 'center';
            modalBg.style.zIndex = 1000;

            const modal = document.createElement('div');
            modal.style.background = '#fff';
            modal.style.borderRadius = '12px';
            modal.style.boxShadow = '0 4px 24px rgba(42,77,105,0.15)';
            modal.style.padding = '2em 2em';
            modal.style.minWidth = '320px';
            modal.innerHTML = `
                <h3>Új állomás hozzáadása</h3>
                <label>
                    Név:<br>
                    <input type="text" id="new-name" value="${name}" style="width:100%;padding:0.5em;margin-bottom:1em;">
                </label>
                <label>
                    Státusz:<br>
                    <select id="new-status" style="width:100%;padding:0.5em;">
                        <option value="aktív" ${status === "aktív" ? "selected" : ""}>Aktív</option>
                        <option value="inaktív" ${status === "inaktív" ? "selected" : ""}>Inaktív</option>
                    </select>
                </label>
                <label>
                    Pozíció:<br>
                    <input type="number" id="new-lat" value="${lat}" step="0.0001" style="width:48%;padding:0.5em;">
                    <input type="number" id="new-lng" value="${lng}" step="0.0001" style="width:48%;padding:0.5em;">
                </label>
                <div style="margin-top:1.5em; text-align:right;">
                    <button id="new-save">Hozzáadás</button>
                    <button id="new-cancel" style="background:#b0c4de;color:#2a4d69;">Mégsem</button>
                </div>
                <div style="margin-top:1em;">
                    <button id="new-pick-on-map" style="background:#4b86b4;">Kijelölés térképen</button>
                    <span id="new-pick-hint" style="color:#888;font-size:0.95em;"></span>
                </div>
            `;
            modalBg.appendChild(modal);
            document.body.appendChild(modalBg);

            let picking = false;
            document.getElementById('new-pick-on-map').onclick = function() {
                picking = true;
                // Mentsük el az aktuális értékeket
                const currentName = document.getElementById('new-name').value.trim();
                const currentStatus = document.getElementById('new-status').value;
                document.body.removeChild(modalBg);
                let hintDiv = document.createElement('div');
                hintDiv.id = "new-pick-hint-map";
                hintDiv.style.position = "fixed";
                hintDiv.style.top = "20px";
                hintDiv.style.left = "50%";
                hintDiv.style.transform = "translateX(-50%)";
                hintDiv.style.background = "#4b86b4";
                hintDiv.style.color = "#fff";
                hintDiv.style.padding = "1em 2em";
                hintDiv.style.borderRadius = "8px";
                hintDiv.style.zIndex = 2000;
                hintDiv.style.boxShadow = "0 2px 8px rgba(42,77,105,0.15)";
                hintDiv.innerText = "Kattints a térképen az új állomás pozíciójához!";
                document.body.appendChild(hintDiv);

                map.getContainer().style.cursor = "crosshair";
                map.once('click', function(e) {
                    document.body.removeChild(hintDiv);
                    map.getContainer().style.cursor = "";
                    // Újra megnyitjuk a modalt, az előző értékekkel, de az új koordinátákkal
                    addStationModal(e.latlng.lat, e.latlng.lng, currentName, currentStatus);
                });
            };

            document.getElementById('new-save').onclick = function() {
                const name = document.getElementById('new-name').value.trim();
                const status = document.getElementById('new-status').value;
                const latVal = parseFloat(document.getElementById('new-lat').value);
                const lngVal = parseFloat(document.getElementById('new-lng').value);
                if (!name || isNaN(latVal) || isNaN(lngVal)) {
                    alert("Minden mező kitöltése kötelező!");
                    return;
                }
                const newId = stations.length > 0 ? Math.max(...stations.map(s => s.id)) + 1 : 1;
                stations.push({
                    id: newId,
                    name: name,
                    status: status,
                    lat: latVal,
                    lng: lngVal
                });
                stats.stations = stations.length;
                stats.activeStations = stations.filter(s => s.status === "aktív").length;
                renderStats();
                renderStations();
                document.body.removeChild(modalBg);
            };
            document.getElementById('new-cancel').onclick = function() {
                document.body.removeChild(modalBg);
                if (picking) map.getContainer().style.cursor = "";
            };
        }


    </script>
</body>
</html>
